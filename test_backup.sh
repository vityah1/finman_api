#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è –±–µ–∫–∞–ø—É –ë–î FinMan
# –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è: ./test_backup.sh

echo "=== –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è —Å–∏—Å—Ç–µ–º–∏ –±–µ–∫–∞–ø—É FinMan ==="

# –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —ñ—Å–Ω—É—î .env —Ñ–∞–π–ª
if [ ! -f .env ]; then
    echo "‚ùå –§–∞–π–ª .env –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ!"
    exit 1
fi

# –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ mysqldump –¥–æ—Å—Ç—É–ø–Ω–∏–π
if ! command -v mysqldump &> /dev/null; then
    echo "‚ùå mysqldump –Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!"
    echo "–í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å: sudo apt-get install mysql-client"
    exit 1
fi

# –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ backup_db.sh –≤–∏–∫–æ–Ω—É–≤–∞–Ω–∏–π
if [ ! -x backup_db.sh ]; then
    echo "‚ùå backup_db.sh –Ω–µ –≤–∏–∫–æ–Ω—É–≤–∞–Ω–∏–π!"
    echo "–í–∏–∫–æ–Ω–∞–π—Ç–µ: chmod +x backup_db.sh"
    exit 1
fi

echo "‚úÖ –í—Å—ñ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ –ø–µ—Ä–µ–≤—ñ—Ä–µ–Ω—ñ"
echo ""

# –¢–µ—Å—Ç—É—î–º–æ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –±–µ–∫–∞–ø—É
echo "üîÑ –¢–µ—Å—Ç—É—î–º–æ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –±–µ–∫–∞–ø—É..."
TEST_BACKUP_FILE="test_backup_$(date +%Y%m%d_%H%M%S).sql"

if ./backup_db.sh "$TEST_BACKUP_FILE"; then
    echo "‚úÖ –ë–µ–∫–∞–ø —É—Å–ø—ñ—à–Ω–æ —Å—Ç–≤–æ—Ä–µ–Ω–æ!"
    
    # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Ä–æ–∑–º—ñ—Ä —Ñ–∞–π–ª—É
    if [ -f "$TEST_BACKUP_FILE" ]; then
        SIZE=$(du -h "$TEST_BACKUP_FILE" | cut -f1)
        echo "üìä –†–æ–∑–º—ñ—Ä —Ñ–∞–π–ª—É: $SIZE"
        
        # –í–∏–¥–∞–ª—è—î–º–æ —Ç–µ—Å—Ç–æ–≤–∏–π —Ñ–∞–π–ª
        read -p "–í–∏–¥–∞–ª–∏—Ç–∏ —Ç–µ—Å—Ç–æ–≤–∏–π —Ñ–∞–π–ª $TEST_BACKUP_FILE? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            rm "$TEST_BACKUP_FILE"
            echo "üóëÔ∏è –¢–µ—Å—Ç–æ–≤–∏–π —Ñ–∞–π–ª –≤–∏–¥–∞–ª–µ–Ω–æ"
        fi
    fi
else
    echo "‚ùå –ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –±–µ–∫–∞–ø—É!"
    exit 1
fi

echo ""
echo "‚úÖ –°–∏—Å—Ç–µ–º–∞ –±–µ–∫–∞–ø—É –ø—Ä–∞—Ü—é—î –ø—Ä–∞–≤–∏–ª—å–Ω–æ!"
